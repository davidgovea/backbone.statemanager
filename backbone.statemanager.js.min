!function(){!function(a,b){return"undefined"!=typeof exports&&null!==exports?module.exports=b(require("backbone"),require("underscore")):b(a.Backbone,a._)}(this,function(a,b){var c,d;return c=a.StateManager=function(a,b){return this.options=null!=b?b:{},this.states=new c.States(a),this},c.extend=a.View.extend,b.extend(c.prototype,a.Events,{getCurrentState:function(){return this.currentState},addState:function(a,b){return this.states.add(a,b),this.trigger("add:state",a)},removeState:function(a){return this.states.remove(a),this.trigger("remove:state",a)},initialize:function(a){var b;return null==a&&(a={}),(b=this.states.findInitial())?this.triggerState(b,a):void 0},triggerState:function(a,c){return null==c&&(c={}),a!==this.currentState||c.reEnter?(b.extend(c,{toState:a,fromState:this.currentState}),this.currentState&&this.exitState(c),this.enterState(a,c)):!1},enterState:function(a,c){var d,e,f;return null==c&&(c={}),(d=this.states.find(a))&&b.isFunction(d.enter)?(this.trigger("before:enter:state",a,d,c),"function"==typeof(e=d.findTransition("onBeforeEnterFrom",c.fromState))&&e(c),d.enter(c),"function"==typeof(f=d.findTransition("onEnterFrom",c.fromState))&&f(c),this.trigger("enter:state",a,d,c),this.currentState=a,this):!1},exitState:function(a){var c,d,e;return null==a&&(a={}),(c=this.states.find(this.currentState))&&b.isFunction(c.exit)?(this.trigger("before:exit:state",this.currentState,c,a),"function"==typeof(d=c.findTransition("onBeforeExitTo",a.toState))&&d(a),c.exit(a),"function"==typeof(e=c.findTransition("onExitTo",a.toState))&&e(a),this.trigger("exit:state",this.currentState,c,a),delete this.currentState,this):!1}}),c.States=function(a){var c=this;return this.states={},a&&b.isObject(a)&&b.each(a,function(a,b){return c.add(b,a)}),this},b.extend(c.States.prototype,{add:function(a,d){return b.isString(a)&&b.isObject(d)?this.states[a]=new c.State(a,d):!1},remove:function(a){return b.isString(a)?delete this.states[a]:!1},find:function(a){return b.isString(a)?b.chain(this.states).find(function(b){return b.matchName(a)}).value():!1},findInitial:function(){var a;return null!=(a=b.find(this.states,function(a){return a.initial}))?a.name:void 0}}),c.State=function(a,d){return this.name=a,b.extend(this,d),this.regExpName=c.State._regExpStateConversion(this.name),this},b.extend(c.State.prototype,{matchName:function(a){return this.regExpName.test(a)},findTransition:function(a,d){return this.transitions&&b.isString(d)&&b.isString(a)?b.find(this.transitions,function(b,e){var f;return 0===e.indexOf(""+a+":")?(e=(f=e.indexOf(":not:")===a.length)?e.slice(a.length+5):e.slice(a.length+1),c.State._regExpStateConversion(e).test(d)!==f):void 0}):!1}}),c.State._regExpStateConversion=function(a){return a=a.replace(/[-[\]{}()+?.,\\^$|#\s]/g,"\\$&").replace(/:\w+/g,"([^/]+)").replace(/\*\w+/g,"(.*?)"),new RegExp("^"+a+"$")},c.addStateManager=function(c,e){var f,g;return null==e&&(e={}),c||new Error("Target must be defined"),g=b.isFunction(c.states)?c.states():c.states,d(g,c),c.stateManager=f=new a.StateManager(g,e),c.triggerState=function(){return f.triggerState.apply(f,arguments)},c.getCurrentState=function(){return f.getCurrentState()},(e.initialize||b.isUndefined(e.initialize))&&f.initialize(e),delete c.states},d=function(a){var c;return c=b.last(arguments),b.each(a,function(e,f){return b.isFunction(e)?a[f]=b.bind(e,c):b.isObject(e)?a[f]=d(e,c):void 0}),a},c})()}.call(this);